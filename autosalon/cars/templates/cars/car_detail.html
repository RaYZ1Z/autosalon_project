{% extends 'vue_main_base.html' %}
{% load humanize %}

{% block title %}{{ car.brand }} {{ car.model }} - AutoElite{% endblock %}

{% block extra_css %}
<style>
.car-detail-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 40px 20px;
}

.car-detail-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 40px;
    margin-top: 30px;
}

.car-gallery-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.car-image {
    width: 100%;
    height: 500px;
    object-fit: cover;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.carousel-control-prev,
.carousel-control-next {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.5);
    border: none;
    top: 50%;
    transform: translateY(-50%);
}

.carousel-control-prev {
    left: 20px;
}

.carousel-control-next {
    right: 20px;
}

.carousel-indicators {
    bottom: 20px;
}

.carousel-indicators button {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.5);
    border: none;
    margin: 0 4px;
}

.carousel-indicators .active {
    background-color: #fbbf24;
}

.car-info-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.car-title {
    font-size: 2.5rem;
    font-weight: 800;
    color: #f8fafc;
    margin-bottom: 30px;
    text-align: center;
}

.specs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.spec-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 20px;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 15px;
    transition: all 0.3s ease;
}

.spec-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.spec-icon {
    font-size: 2rem;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.spec-icon {
    background: rgba(107, 114, 128, 0.2);
    color: #6b7280;
}

.spec-value {
    font-size: 1.4rem;
    font-weight: 700;
    color: #f8fafc;
    margin-bottom: 5px;
}

.spec-label {
    color: #cbd5e1;
    font-size: 0.9rem;
    font-weight: 500;
}

.spec-text {
    display: flex;
    flex-direction: column;
}

.car-description {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 25px;
    margin-top: 30px;
}

.description-title {
    color: #fbbf24;
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.description-content {
    color: #cbd5e1;
    line-height: 1.6;
    font-size: 1rem;
}

.car-actions-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    margin-bottom: 30px;
}

.actions-title {
    color: #fbbf24;
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 20px;
    text-align: center;
}

.btn-favorite {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 2px solid #ef4444;
    padding: 15px 24px;
    border-radius: 50px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    margin-bottom: 10px;
    backdrop-filter: blur(10px);
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-favorite:hover {
    background: #ef4444;
    color: white;
    transform: translateY(-2px);
}

.btn-favorite.active {
    background: #ef4444;
    color: white;
}

.btn-request {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border: none;
    padding: 15px 24px;
    border-radius: 50px;
    font-weight: 600;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    margin-bottom: 10px;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-request:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
}

.btn-login, .btn-signup {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
    border: 2px solid #3b82f6;
    padding: 12px 24px;
    border-radius: 50px;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    width: 100%;
    text-align: center;
    margin-bottom: 10px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.btn-login:hover, .btn-signup:hover {
    background: #3b82f6;
    color: white;
    transform: translateY(-2px);
}

.btn-back {
    background: rgba(255, 255, 255, 0.1);
    color: #f8fafc;
    border: 2px solid rgba(255, 255, 255, 0.3);
    padding: 12px 24px;
    border-radius: 50px;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    width: 100%;
    text-align: center;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.btn-back:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
}

.similar-cars-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.similar-title {
    color: #fbbf24;
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 20px;
    text-align: center;
}

.similar-car-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
    text-decoration: none;
    color: inherit;
}

.similar-car-item:hover {
    background: rgba(255, 255, 255, 0.05);
    transform: translateX(5px);
    border-radius: 10px;
}

.similar-car-image {
    width: 70px;
    height: 50px;
    border-radius: 8px;
    object-fit: cover;
    margin-right: 15px;
    background: rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
}

.similar-car-image i {
    color: #64748b;
    font-size: 1.2rem;
}

.similar-car-info {
    flex: 1;
}

.similar-car-title {
    font-weight: 600;
    color: #f8fafc;
    margin-bottom: 3px;
    font-size: 0.95rem;
}

.similar-car-price {
    color: #10b981;
    font-weight: 700;
    font-size: 0.9rem;
    margin-bottom: 2px;
}

.similar-car-details {
    color: #64748b;
    font-size: 0.8rem;
}

.similar-car-arrow {
    color: #64748b;
    font-size: 1rem;
}

.alert-info {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    color: #3b82f6;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

@media (max-width: 992px) {
    .car-detail-grid {
        grid-template-columns: 1fr;
        gap: 30px;
    }

    .car-title {
        font-size: 2rem;
    }
}

@media (max-width: 768px) {
    .car-detail-container {
        padding: 20px 15px;
    }

    .specs-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .car-image {
        height: 300px;
    }

    .car-title {
        font-size: 1.8rem;
    }
}
</style>
{% endblock %}

{% block vue_content %}
<div class="car-detail-container">
    <!-- Хлебные крошки -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/vue-cars/" style="color: #fbbf24;">Главная</a></li>
            <li class="breadcrumb-item active" aria-current="page" style="color: #cbd5e1;">{{ car.brand }} {{ car.model }}</li>
        </ol>
    </nav>

    <div class="car-detail-grid">
        <div>
            <!-- Галерея изображений -->
            {% load static %}
            <div class="car-gallery-card">
                <div id="carCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        {% if car.images %}
                            {% for image in car.images %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                <img src="{{ image.url }}" class="d-block w-100 car-image" alt="Фото автомобиля {{ car.brand }} {{ car.model }}">
                            </div>
                            {% endfor %}
                        {% else %}
                            <!-- Placeholder: показываем заглушку, если нет фотографий -->
                            <div class="carousel-item active">
                                <div class="d-block w-100 car-image d-flex align-items-center justify-content-center bg-light">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-car fa-4x mb-3"></i>
                                        <h5>Фото автомобиля</h5>
                                        <p>Фотографии временно недоступны</p>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    {% if car.images|length > 1 or not car.images %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#carCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Предыдущее фото</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Следующее фото</span>
                    </button>
                    {% endif %}

                    <!-- Индикаторы -->
                    {% if car.images|length > 1 %}
                    <div class="carousel-indicators">
                        {% for image in car.images %}
                        <button type="button" data-bs-target="#carCarousel" data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active"{% endif %} aria-label="Фото {{ forloop.counter }}"></button>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Основная информация -->
            <div class="car-info-card">
                <h1 class="car-title">{{ car.brand }} {{ car.model }}</h1>

                <div class="specs-grid">
                    <div class="spec-card spec-price">
                        <div class="spec-icon">
                            <i class="fas fa-ruble-sign"></i>
                        </div>
                        <div class="spec-text">
                            <div class="spec-value">{{ car.price|floatformat:0|intcomma }} ₽</div>
                            <div class="spec-label">Цена</div>
                        </div>
                    </div>
                    <div class="spec-card spec-year">
                        <div class="spec-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="spec-value">{{ car.year }} год</div>
                        <div class="spec-label">Год выпуска</div>
                    </div>
                    <div class="spec-card spec-mileage">
                        <div class="spec-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <div class="spec-value">{{ car.mileage|floatformat:0|intcomma }} км</div>
                        <div class="spec-label">Пробег</div>
                    </div>
                    <div class="spec-card spec-color">
                        <div class="spec-icon">
                            <i class="fas fa-palette"></i>
                        </div>
                        <div class="spec-value">{{ car.color }}</div>
                        <div class="spec-label">Цвет</div>
                    </div>
                    <div class="spec-card spec-transmission">
                        <div class="spec-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div class="spec-value">{{ car.transmission }}</div>
                        <div class="spec-label">Коробка передач</div>
                    </div>
                    <div class="spec-card spec-fuel">
                        <div class="spec-icon">
                            <i class="fas fa-gas-pump"></i>
                        </div>
                        <div class="spec-value">{{ car.fuel_type }}</div>
                        <div class="spec-label">Тип топлива</div>
                    </div>
                </div>

                {% if car.description %}
                <div class="car-description">
                    <div class="description-title">
                        <i class="fas fa-info-circle"></i>
                        Описание
                    </div>
                    <div class="description-content">{{ car.description|linebreaks }}</div>
                </div>
                {% endif %}
            </div>
        </div>

        <div>
            <!-- Действия -->
            <div class="car-actions-card">
                <div class="actions-title">
                    <i class="fas fa-shopping-cart me-2"></i>Действия
                </div>

                {% if user.is_authenticated %}
                <a href="{% url 'cars:create_purchase_request' car.id %}" class="btn-request">
                    <i class="fas fa-credit-card me-2"></i>Оформить заявку
                </a>

                <!-- Кнопка избранного -->
                <button id="favorite-btn" class="btn-favorite {% if is_favorite %}active{% endif %}" onclick="toggleFavorite({{ car.id }})">
                    <i id="favorite-icon" class="fas fa-heart me-2"></i>
                    <span id="favorite-text">{% if is_favorite %}Удалить из избранного{% else %}Добавить в избранное{% endif %}</span>
                </button>
                {% else %}
                <div class="alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Войдите в аккаунт</strong><br>
                    <small>Чтобы оформить заявку на покупку</small>
                </div>
                <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="btn-login">
                    <i class="fas fa-sign-in-alt me-2"></i>Войти
                </a>
                <a href="{% url 'accounts:signup' %}" class="btn-signup">
                    <i class="fas fa-user-plus me-2"></i>Регистрация
                </a>
                {% endif %}

                <hr style="border-color: rgba(255, 255, 255, 0.1); margin: 20px 0;">

                <a href="/vue-cars/" class="btn-back">
                    <i class="fas fa-arrow-left me-2"></i>К списку автомобилей
                </a>
            </div>

            <!-- Похожие автомобили -->
            {% if similar_cars %}
            <div class="similar-cars-card">
                <div class="similar-title">
                    <i class="fas fa-car me-2"></i>Похожие автомобили
                </div>
                {% for similar_car in similar_cars %}
                <a href="{% url 'cars:car_detail' similar_car.id %}" class="similar-car-item">
                    {% if similar_car.images.first %}
                    <img src="{{ similar_car.images.first.image.url }}" alt="{{ similar_car.brand.name }} {{ similar_car.model }}" class="similar-car-image">
                    {% else %}
                    <div class="similar-car-image">
                        <i class="fas fa-car"></i>
                    </div>
                    {% endif %}
                    <div class="similar-car-info">
                        <div class="similar-car-title">{{ similar_car.brand.name }} {{ similar_car.model }}</div>
                        <div class="similar-car-price">{{ similar_car.price|floatformat:0|intcomma }} ₽</div>
                        <div class="similar-car-details">{{ similar_car.year }} г., {{ similar_car.mileage|floatformat:0|intcomma }} км</div>
                    </div>
                    <i class="fas fa-chevron-right similar-car-arrow"></i>
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Функция для обновления состояния кнопки избранного
function updateFavoriteButton(isFavorite) {
    const btn = document.getElementById('favorite-btn');
    const icon = document.getElementById('favorite-icon');
    const text = document.getElementById('favorite-text');

    if (isFavorite) {
        btn.className = 'btn-favorite active';
        icon.className = 'fas fa-heart me-2';
        text.textContent = 'Удалить из избранного';
    } else {
        btn.className = 'btn-favorite';
        icon.className = 'fas fa-heart me-2';
        text.textContent = 'Добавить в избранное';
    }
}

// Функция для проверки состояния избранного
async function checkFavoriteStatus(carId) {
    try {
        const response = await fetch(`/api/favorites/${carId}/check/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            updateFavoriteButton(data.is_favorite);
        } else {
            console.error('Ошибка ответа API:', response.status, response.statusText);
        }
    } catch (error) {
        console.error('Ошибка проверки статуса избранного:', error);
    }
}

async function toggleFavorite(carId) {
    try {
        const response = await fetch('/api/favorites/toggle/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({ car_id: carId })
        });

        if (response.ok) {
            const data = await response.json();
            const isFavorite = data.action === 'added';
            updateFavoriteButton(isFavorite);

            // Сохраняем состояние в localStorage для синхронизации с каталогом
            const favorites = JSON.parse(localStorage.getItem('autoelite_favorites_sync') || '[]');
            if (isFavorite) {
                if (!favorites.includes(carId)) {
                    favorites.push(carId);
                }
            } else {
                const index = favorites.indexOf(carId);
                if (index > -1) {
                    favorites.splice(index, 1);
                }
            }
            localStorage.setItem('autoelite_favorites_sync', JSON.stringify(favorites));

            alert(isFavorite ? 'Добавлено в избранное' : 'Удалено из избранного');
        } else if (response.status === 401) {
            alert('Необходимо войти в систему');
        } else {
            alert('Ошибка при работе с избранным');
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка при работе с избранным');
    }
}

// Проверяем статус избранного при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    const carId = {{ car.id }};
    checkFavoriteStatus(carId);
});
</script>
{% endblock %}