{% extends 'vue_main_base.html' %}
{% load humanize %}

{% block title %}Профиль пользователя{% endblock %}

{% block extra_css %}
<style>
.profile-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
}

.profile-grid {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 30px;
    margin-top: 30px;
}

.profile-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 30px;
    transition: all 0.3s ease;
}

.profile-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
}

.profile-header {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #1e1b4b;
    padding: 20px;
    border-radius: 15px 15px 0 0;
    text-align: center;
    margin: -30px -30px 30px -30px;
}

.profile-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #fbbf24;
    margin: 0 auto 20px;
    display: block;
    box-shadow: 0 8px 25px rgba(251, 191, 36, 0.3);
}

.profile-name {
    font-size: 1.5rem;
    font-weight: 700;
    color: #f8fafc;
    margin-bottom: 5px;
}

.profile-username {
    color: #cbd5e1;
    margin-bottom: 15px;
}

.role-badge {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.role-admin { background: #ef4444; color: white; }
.role-manager { background: #f59e0b; color: #1e1b4b; }
.role-user { background: #3b82f6; color: white; }

.profile-info-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    color: #cbd5e1;
}

.profile-info-item:last-child {
    border-bottom: none;
}

.profile-info-item i {
    color: #fbbf24;
    width: 20px;
    text-align: center;
}

.profile-actions {
    margin-top: 30px;
}

.btn-profile-edit {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #1e1b4b;
    border: none;
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    width: 100%;
    text-align: center;
    margin-bottom: 12px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
}

.btn-profile-edit:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(251, 191, 36, 0.4);
}

.btn-logout {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 2px solid #ef4444;
    padding: 10px 22px;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    width: 100%;
    text-align: center;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.btn-logout:hover {
    background: #ef4444;
    color: white;
    transform: translateY(-2px);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.stat-icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
    opacity: 0.8;
}

.stat-value {
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 5px;
}

.stat-label {
    color: #cbd5e1;
    font-size: 0.9rem;
    font-weight: 500;
}

.requests-section, .favorites-section {
    margin-bottom: 30px;
}

.section-header {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #1e1b4b;
    padding: 15px 25px;
    border-radius: 15px 15px 0 0;
    margin: -30px -30px 30px -30px;
}

.section-header h5 {
    margin: 0;
    font-weight: 700;
}

.request-item, .favorite-item {
    display: flex;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
}

.request-item:hover, .favorite-item:hover {
    background: rgba(255, 255, 255, 0.02);
    transform: translateX(5px);
}

.request-image, .favorite-image {
    width: 80px;
    height: 60px;
    border-radius: 8px;
    object-fit: cover;
    margin-right: 20px;
    background: rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
}

.request-image i, .favorite-image i {
    color: #64748b;
    font-size: 1.5rem;
}

.request-info, .favorite-info {
    flex: 1;
}

.request-title, .favorite-title {
    font-weight: 600;
    color: #f8fafc;
    margin-bottom: 5px;
}

.request-price, .favorite-price {
    color: #fbbf24;
    font-weight: 700;
    margin-bottom: 3px;
}

.request-date, .favorite-date {
    color: #64748b;
    font-size: 0.85rem;
}

.request-status {
    text-align: right;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-approved { background: #10b981; color: white; }
.status-rejected { background: #ef4444; color: white; }
.status-new, .status-pending { background: #f59e0b; color: #1e1b4b; }

.btn-view-details {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
    border: 1px solid #3b82f6;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 0.8rem;
    text-decoration: none;
    transition: all 0.3s ease;
}

.btn-view-details:hover {
    background: #3b82f6;
    color: white;
}

.empty-state {
    text-align: center;
    padding: 60px 30px;
    color: #64748b;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-state h5 {
    color: #cbd5e1;
    margin-bottom: 10px;
}

.empty-state p {
    margin-bottom: 25px;
}

.btn-primary-main {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #1e1b4b;
    border: none;
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
}

.btn-primary-main:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(251, 191, 36, 0.4);
}

.favorites-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.favorite-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    overflow: hidden;
    transition: all 0.3s ease;
}

.favorite-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.favorite-image {
    height: 140px;
    background: rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
}

.favorite-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.favorite-content {
    padding: 15px;
}

.favorite-title {
    color: #f8fafc;
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 8px;
    line-height: 1.3;
}

.favorite-price {
    color: #fbbf24;
    font-weight: 700;
    font-size: 0.85rem;
    margin-bottom: 5px;
}

.favorite-date {
    color: #64748b;
    font-size: 0.75rem;
}

.favorite-actions {
    padding: 15px;
    padding-top: 0;
}

@media (max-width: 992px) {
    .profile-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .stats-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

.status-update-form {
    max-width: 200px;
}

.status-select {
    font-size: 0.8rem;
}

.manager-comment {
    font-size: 0.8rem;
    resize: vertical;
}

.update-status-btn {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

.toggle-requests-btn {
    border: 1px solid rgba(251, 191, 36, 0.3);
    color: #fbbf24;
    transition: all 0.3s ease;
}

.toggle-requests-btn:hover {
    background: rgba(251, 191, 36, 0.1);
    border-color: #fbbf24;
    color: #f59e0b;
}

.toggle-icon {
    transition: transform 0.3s ease;
}

.collapsed .toggle-icon {
    transform: rotate(180deg);
}

@media (max-width: 768px) {
    .profile-container {
        padding: 20px 15px;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .favorites-grid {
        grid-template-columns: 1fr;
    }

    .status-update-form {
        max-width: none;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработка форм изменения статуса заявок
    const statusForms = document.querySelectorAll('.status-update-form');

    statusForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const requestId = this.dataset.requestId;
            const statusSelect = this.querySelector('.status-select');
            const commentTextarea = this.querySelector('.manager-comment');
            const submitBtn = this.querySelector('.update-status-btn');

            // Отключаем кнопку во время отправки
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Сохранение...';

            // Собираем данные формы
            const formData = new FormData();
            formData.append('status', statusSelect.value);
            formData.append('manager_comment', commentTextarea.value);

            // Отправляем AJAX запрос
            fetch(`/accounts/update-request-status/${requestId}/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Обновляем статус в интерфейсе
                    const statusBadge = this.closest('.request-item').querySelector('.status-badge');
                    if (statusBadge) {
                        statusBadge.className = `status-badge status-${data.new_status}`;
                        statusBadge.textContent = data.new_status_display;
                    }

                    // Показываем уведомление об успехе
                    showNotification('Статус заявки успешно обновлен!', 'success');
                } else {
                    showNotification(data.error || 'Произошла ошибка при обновлении статуса', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Произошла ошибка при отправке запроса', 'error');
            })
            .finally(() => {
                // Включаем кнопку обратно
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Обновить';
            });
        });
    });

    // Функция для показа уведомлений
    function showNotification(message, type) {
        // Создаем элемент уведомления
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        // Добавляем в DOM
        document.body.appendChild(notification);

        // Автоматически скрываем через 5 секунд
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    // Обработка сворачивания/разворачивания списка заявок
    const requestsCollapse = document.getElementById('requestsCollapse');
    if (requestsCollapse) {
        requestsCollapse.addEventListener('shown.bs.collapse', function () {
            const toggleBtn = document.querySelector('.toggle-requests-btn');
            if (toggleBtn) {
                toggleBtn.setAttribute('aria-expanded', 'true');
            }
        });

        requestsCollapse.addEventListener('hidden.bs.collapse', function () {
            const toggleBtn = document.querySelector('.toggle-requests-btn');
            if (toggleBtn) {
                toggleBtn.setAttribute('aria-expanded', 'false');
            }
        });
    }
});
</script>
{% endblock %}

{% block vue_content %}
<div class="container profile-container">
    <div class="profile-grid">
        <!-- Левая колонка - Профиль пользователя -->
        <div class="profile-card">
            <div class="profile-header">
                <i class="fas fa-user-circle fa-2x mb-2"></i>
                <h5>Профиль</h5>
            </div>

            {% if user.profile_picture %}
            <img src="{{ user.profile_picture.url }}" alt="Аватар" class="profile-avatar">
            {% else %}
            <div class="profile-avatar bg-primary d-flex align-items-center justify-content-center">
                <i class="fas fa-user fa-3x text-white"></i>
            </div>
            {% endif %}

            <h4 class="profile-name">{{ user.get_full_name|default:user.username }}</h4>
            <p class="profile-username">@{{ user.username }}</p>

            <div class="text-center mb-4">
                <span class="role-badge role-{{ user.role }}">
                    {{ user.get_role_display }}
                </span>
            </div>

            <div class="profile-info">
                {% if user.phone_number %}
                <div class="profile-info-item">
                    <i class="fas fa-phone"></i>
                    <span>{{ user.phone_number }}</span>
                </div>
                {% endif %}

                <div class="profile-info-item">
                    <i class="fas fa-envelope"></i>
                    <span>{{ user.email }}</span>
                </div>

                <div class="profile-info-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Регистрация: {{ user.date_joined|date:"d.m.Y" }}</span>
                </div>
            </div>

            <div class="profile-actions">
                <a href="{% url 'accounts:profile_edit' %}" class="btn-profile-edit">
                    <i class="fas fa-edit me-2"></i>Редактировать профиль
                </a>
                <form method="post" action="{% url 'accounts:logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="btn-logout">
                        <i class="fas fa-sign-out-alt me-2"></i>Выйти
                    </button>
                </form>
            </div>
        </div>

        <!-- Правая колонка - Статистика и данные -->
        <div>
            <!-- Статистика -->
            <div class="stats-grid">
                {% if is_manager %}
                <div class="stat-card">
                    <div class="stat-icon" style="color: #10b981;">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-value" style="color: #10b981;">{{ purchase_requests_count }}</div>
                    <div class="stat-label">Всех заявок</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="color: #f59e0b;">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-value" style="color: #f59e0b;">{{ active_requests_count }}</div>
                    <div class="stat-label">Активных заявок</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="color: #3b82f6;">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="stat-value" style="color: #3b82f6;">{{ user_requests_count }}</div>
                    <div class="stat-label">Моих заявок</div>
                </div>
                {% else %}
                <div class="stat-card">
                    <div class="stat-icon" style="color: #10b981;">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-value" style="color: #10b981;">{{ user.purchase_requests.count }}</div>
                    <div class="stat-label">Заявок на покупку</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="color: #f59e0b;">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-value" style="color: #f59e0b;">{{ user.favorites.count }}</div>
                    <div class="stat-label">Избранных авто</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="color: #3b82f6;">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-value" style="color: #3b82f6;">{{ active_requests_count }}</div>
                    <div class="stat-label">Активных заявок</div>
                </div>
                {% endif %}
            </div>

            <!-- Управление заявками (для менеджеров) -->
            {% if is_manager %}
            <div class="profile-card requests-section">
                <div class="section-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-cogs me-2"></i>
                        <span>Управление заявками</span>
                    </div>
                    <button class="btn btn-sm btn-outline-light toggle-requests-btn" type="button" data-bs-toggle="collapse" data-bs-target="#requestsCollapse" aria-expanded="true" aria-controls="requestsCollapse">
                        <i class="fas fa-chevron-up toggle-icon"></i>
                    </button>
                </div>

                <div class="collapse show" id="requestsCollapse">

                {% if all_requests %}
                {% for request in all_requests %}
                <div class="request-item">
                    {% if request.car.images.first %}
                    <img src="{{ request.car.images.first.image.url }}" alt="{{ request.car.brand.name }} {{ request.car.model }}" class="request-image">
                    {% else %}
                    <div class="request-image">
                        <i class="fas fa-car"></i>
                    </div>
                    {% endif %}

                    <div class="request-info">
                        <div class="request-title">{{ request.car.brand.name }} {{ request.car.model }}</div>
                        <div class="request-price">{{ request.car.price|floatformat:0|intcomma }} ₽</div>
                        <div class="request-date">{{ request.created_at|date:"d.m.Y H:i" }}</div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-user me-1"></i>{{ request.contact_name }} ({{ request.contact_phone }})
                            </small>
                        </div>
                        {% if request.message %}
                        <div class="mt-1">
                            <small class="text-muted">
                                <i class="fas fa-comment me-1"></i>{{ request.message|truncatechars:50 }}
                            </small>
                        </div>
                        {% endif %}
                    </div>

                    <div class="request-status">
                        <form class="status-update-form" data-request-id="{{ request.id }}">
                            <select class="form-select form-select-sm mb-2 status-select" name="status">
                                {% for status_value, status_label in request.STATUS_CHOICES %}
                                <option value="{{ status_value }}" {% if request.status == status_value %}selected{% endif %}>
                                    {{ status_label }}
                                </option>
                                {% endfor %}
                            </select>
                            <textarea class="form-control form-control-sm mb-2 manager-comment" name="manager_comment" rows="2" placeholder="Комментарий менеджера">{{ request.manager_comment }}</textarea>
                            <button type="submit" class="btn btn-sm btn-primary update-status-btn">
                                <i class="fas fa-save me-1"></i>Обновить
                            </button>
                        </form>
                        <br>
                        <a href="{% url 'cars:purchase_request_detail' request.pk %}" class="btn-view-details mt-1">
                            <i class="fas fa-eye me-1"></i>Подробнее
                        </a>
                    </div>
                </div>
                {% endfor %}

                <div class="text-center mt-3">
                    <a href="{% url 'cars:purchase_request_list' %}" class="btn-primary-main">
                        <i class="fas fa-list me-2"></i>Все заявки
                    </a>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-shopping-cart"></i>
                    <h5>Заявок пока нет</h5>
                    <p>Новые заявки на покупку автомобилей будут отображаться здесь</p>
                </div>
                {% endif %}
               </div>
            </div>
            {% endif %}

            <!-- Заявки -->
            {% if not is_manager and user.purchase_requests.exists %}
            <div class="profile-card requests-section">
                <div class="section-header">
                    <i class="fas fa-list me-2"></i>
                    <span>Мои заявки</span>
                </div>

                {% for request in user.purchase_requests.all|slice:":5" %}
                <div class="request-item">
                    {% if request.car.images.first %}
                    <img src="{{ request.car.images.first.image.url }}" alt="{{ request.car.brand.name }} {{ request.car.model }}" class="request-image">
                    {% else %}
                    <div class="request-image">
                        <i class="fas fa-car"></i>
                    </div>
                    {% endif %}

                    <div class="request-info">
                        <div class="request-title">{{ request.car.brand.name }} {{ request.car.model }}</div>
                        <div class="request-price">{{ request.car.price|floatformat:0|intcomma }} ₽</div>
                        <div class="request-date">{{ request.created_at|date:"d.m.Y H:i" }}</div>
                    </div>

                    <div class="request-status">
                        <span class="status-badge status-{{ request.status }}">
                            {{ request.get_status_display }}
                        </span>
                        <br>
                        <a href="{% url 'cars:purchase_request_detail' request.pk %}" class="btn-view-details mt-2">
                            <i class="fas fa-eye me-1"></i>Подробнее
                        </a>
                    </div>
                </div>
                {% endfor %}

                <div class="text-center mt-3">
                    <a href="{% url 'cars:purchase_request_list' %}" class="btn-primary-main">
                        <i class="fas fa-list me-2"></i>Все заявки
                    </a>
                </div>
            </div>
            {% else %}
            <div class="profile-card">
                <div class="empty-state">
                    <i class="fas fa-shopping-cart"></i>
                    <h5>У вас пока нет заявок</h5>
                    <p>Начните с просмотра нашего каталога автомобилей</p>
                    <a href="/vue-cars/" class="btn-primary-main">
                        <i class="fas fa-car me-2"></i>Перейти к автомобилям
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Избранные автомобили -->
            {% if favorite_cars %}
            <div class="profile-card favorites-section">
                <div class="section-header">
                    <i class="fas fa-star me-2"></i>
                    <span>Избранные автомобили</span>
                </div>

                <div class="favorites-grid">
                    {% for favorite in favorite_cars %}
                    <div class="favorite-card">
                        {% if favorite.car.images.first %}
                        <div class="favorite-image">
                            <img src="{{ favorite.car.images.first.image.url }}" alt="{{ favorite.car.brand.name }} {{ favorite.car.model }}">
                        </div>
                        {% else %}
                        <div class="favorite-image">
                            <i class="fas fa-car"></i>
                        </div>
                        {% endif %}

                        <div class="favorite-content">
                            <div class="favorite-title">{{ favorite.car.brand.name }} {{ favorite.car.model }}</div>
                            <div class="favorite-price">{{ favorite.car.price|floatformat:0|intcomma }} ₽</div>
                            <div class="favorite-date">{{ favorite.added_at|date:"d.m.Y" }}</div>
                        </div>

                        <div class="favorite-actions">
                            <a href="{% url 'cars:car_detail' favorite.car.id %}" class="btn-view-details">
                                <i class="fas fa-eye me-1"></i>Подробнее
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if user.favorites.count > 6 %}
                <div class="text-center mt-3">
                    <small style="color: #64748b;">Показаны последние 6 избранных автомобилей</small>
                </div>
                {% endif %}
            </div>
            {% elif user.favorites.count == 0 %}
            <div class="profile-card">
                <div class="empty-state">
                    <i class="fas fa-star"></i>
                    <h5>У вас пока нет избранных автомобилей</h5>
                    <p>Добавляйте автомобили в избранное, чтобы быстро находить их позже</p>
                    <a href="/vue-cars/" class="btn-primary-main">
                        <i class="fas fa-car me-2"></i>Перейти к каталогу
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}
